{% extends "base.html" %}
{% block title %}Chat with {{ other.first_name }} - Matcha{% endblock %}
{% block content %}
<div class="chat-page">
    <div class="chat-sidebar">
        <h2>Conversations</h2>
        <ul class="chat-list">
            {% for item in matches %}
            <li class="chat-item {% if item.user.id == other.id %}active{% endif %}">
                <a href="{{ url_for('chat.conversation', user_id=item.user.id) }}" class="chat-link">
                    <div class="chat-avatar">
                        {% if item.user.profile_picture %}
                        <img src="{{ url_for('uploaded_file', filename=item.user.profile_picture.filename) }}" alt="">
                        {% else %}
                        <div class="no-avatar">?</div>
                        {% endif %}
                        {% if item.user.is_online %}
                        <span class="online-dot"></span>
                        {% endif %}
                    </div>
                    <div class="chat-info">
                        <span class="chat-name">{{ item.user.first_name }}</span>
                    </div>
                    {% if item.unread > 0 %}
                    <span class="unread-badge">{{ item.unread }}</span>
                    {% endif %}
                </a>
            </li>
            {% endfor %}
        </ul>
    </div>
    <div class="chat-main">
        <div class="chat-header">
            <a href="{{ url_for('profile.view', user_id=other.id) }}" class="chat-partner">
                <div class="chat-avatar">
                    {% if other.profile_picture %}
                    <img src="{{ url_for('uploaded_file', filename=other.profile_picture.filename) }}" alt="">
                    {% else %}
                    <div class="no-avatar">?</div>
                    {% endif %}
                </div>
                <div class="chat-partner-info">
                    <span class="chat-partner-name">{{ other.first_name }} {{ other.last_name }}</span>
                    <span class="chat-partner-status">
                        {% if other.is_online %}Online{% elif other.last_seen %}Last seen {{ other.last_seen.strftime('%H:%M') }}{% endif %}
                    </span>
                </div>
            </a>
        </div>
        <div class="chat-messages" id="chat-messages">
            {% for msg in messages %}
            <div class="message {% if msg.sender_id == current_user.id %}sent{% else %}received{% endif %}">
                <div class="message-content">{{ msg.content }}</div>
                <div class="message-time">{{ msg.created_at.strftime('%H:%M') }}</div>
            </div>
            {% endfor %}
        </div>
        <form class="chat-input" id="chat-form">
            <input type="text" id="message-input" placeholder="Type a message..." autocomplete="off" maxlength="2000">
            <button type="submit" class="btn">Send</button>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.6.0/socket.io.min.js"></script>
<script>
(function() {
    var socket = io();
    var messagesDiv = document.getElementById('chat-messages');
    var form = document.getElementById('chat-form');
    var input = document.getElementById('message-input');
    var receiverId = {{ other.id }};

    function scrollToBottom() {
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }
    scrollToBottom();

    socket.on('connect', function() {
        socket.emit('mark_read', {sender_id: receiverId});
    });

    socket.on('new_message', function(data) {
        if (data.sender_id === receiverId) {
            var div = document.createElement('div');
            div.className = 'message received';
            div.innerHTML = '<div class="message-content">' + escapeHtml(data.content) + '</div>' +
                            '<div class="message-time">' + data.created_at.split(' ')[1] + '</div>';
            messagesDiv.appendChild(div);
            scrollToBottom();
            socket.emit('mark_read', {sender_id: receiverId});
        }
    });

    form.addEventListener('submit', function(e) {
        e.preventDefault();
        var content = input.value.trim();
        if (!content) return;
        fetch('{{ url_for("chat.send_message") }}', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({receiver_id: receiverId, content: content})
        })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.success) {
                var div = document.createElement('div');
                div.className = 'message sent';
                div.innerHTML = '<div class="message-content">' + escapeHtml(data.message.content) + '</div>' +
                                '<div class="message-time">' + data.message.created_at.split(' ')[1] + '</div>';
                messagesDiv.appendChild(div);
                scrollToBottom();
                input.value = '';
            }
        });
    });

    function escapeHtml(text) {
        var div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
})();
</script>
{% endblock %}
