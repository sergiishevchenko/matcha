{% extends "base.html" %}
{% block title %}Edit Profile - Matcha{% endblock %}
{% block content %}
<div class="profile-edit">
    <h1>Edit Profile</h1>

    <section class="profile-section">
        <h2>Profile Images</h2>
        <div class="images-grid" id="images-sortable">
            {% for img in images %}
            <div class="image-card {% if img.is_profile_picture %}is-profile{% endif %}" data-id="{{ img.id }}">
                <img src="{{ url_for('uploaded_file', filename=img.filename) }}" alt="Photo" class="sortable-handle">
                <div class="image-actions">
                    {% if not img.is_profile_picture %}
                    <form method="post" action="{{ url_for('profile.set_profile_picture', image_id=img.id) }}">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <button type="submit" class="btn btn-small">Set as main</button>
                    </form>
                    {% else %}
                    <span class="badge">Main photo</span>
                    {% endif %}
                    <button type="button" class="btn btn-small btn-secondary edit-image-btn" data-id="{{ img.id }}" data-src="{{ url_for('uploaded_file', filename=img.filename) }}">Edit</button>
                    <form method="post" action="{{ url_for('profile.delete_image', image_id=img.id) }}">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <button type="submit" class="btn btn-small btn-danger">Delete</button>
                    </form>
                </div>
            </div>
            {% endfor %}
        </div>
        {% if images|length < 5 %}
        <div class="dropzone-area" id="dropzone">
            <p>Drag & drop images here or click to upload</p>
            <input type="file" id="file-input" accept="image/*" multiple style="display:none;">
        </div>
        {% endif %}
        <p class="hint">Drag images to reorder. First image is your profile picture. Max 5 images.</p>
    </section>

    <div id="image-editor-modal" class="modal" style="display:none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Image</h3>
                <button type="button" class="modal-close" id="close-editor">&times;</button>
            </div>
            <div class="modal-body">
                <div class="editor-preview">
                    <img id="editor-image" src="" alt="">
                </div>
                <div class="editor-controls">
                    <button type="button" class="btn btn-small" id="rotate-left">Rotate Left</button>
                    <button type="button" class="btn btn-small" id="rotate-right">Rotate Right</button>
                    <button type="button" class="btn btn-small" id="flip-h">Flip H</button>
                    <button type="button" class="btn btn-small" id="flip-v">Flip V</button>
                </div>
                <div class="editor-filters">
                    <label>Brightness: <input type="range" id="brightness" min="50" max="150" value="100"></label>
                    <label>Contrast: <input type="range" id="contrast" min="50" max="150" value="100"></label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn" id="save-edit">Save Changes</button>
                <button type="button" class="btn btn-secondary" id="cancel-edit">Cancel</button>
            </div>
        </div>
    </div>

    <section class="profile-section">
        <h2>Basic Info</h2>
        <form method="post" action="{{ url_for('profile.edit') }}" class="profile-form">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <div class="form-row">
                <div class="form-group">
                    <label for="first_name">First name</label>
                    <input type="text" id="first_name" name="first_name" value="{{ user.first_name }}" required>
                </div>
                <div class="form-group">
                    <label for="last_name">Last name</label>
                    <input type="text" id="last_name" name="last_name" value="{{ user.last_name }}" required>
                </div>
            </div>
            <div class="form-group">
                <label for="email">Email</label>
                <input type="email" id="email" name="email" value="{{ user.email }}" required>
            </div>
            <div class="form-group">
                <label for="birth_date">Birth date</label>
                <input type="date" id="birth_date" name="birth_date" value="{{ user.birth_date.strftime('%Y-%m-%d') if user.birth_date else '' }}">
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="gender">Gender</label>
                    <select id="gender" name="gender">
                        <option value="">Not specified</option>
                        <option value="male" {% if user.gender == 'male' %}selected{% endif %}>Male</option>
                        <option value="female" {% if user.gender == 'female' %}selected{% endif %}>Female</option>
                        <option value="other" {% if user.gender == 'other' %}selected{% endif %}>Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="sexual_preference">Interested in</label>
                    <select id="sexual_preference" name="sexual_preference">
                        <option value="">Not specified</option>
                        <option value="heterosexual" {% if user.sexual_preference == 'heterosexual' %}selected{% endif %}>Opposite gender</option>
                        <option value="homosexual" {% if user.sexual_preference == 'homosexual' %}selected{% endif %}>Same gender</option>
                        <option value="bisexual" {% if user.sexual_preference == 'bisexual' %}selected{% endif %}>Both</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label for="biography">About me</label>
                <textarea id="biography" name="biography" rows="4" maxlength="2000">{{ user.biography or '' }}</textarea>
            </div>
            <div class="form-group">
                <label for="tags">Interests (comma-separated)</label>
                <input type="text" id="tags" name="tags" value="{{ tags|join(', ') }}" placeholder="music, travel, coding">
                <p class="hint">Add up to 10 tags to describe your interests.</p>
            </div>
            <button type="submit" class="btn">Save changes</button>
        </form>
    </section>

    <section class="profile-section">
        <h2>Location</h2>
        <div class="location-info">
            {% if user.latitude and user.longitude %}
            <p>Current location: {{ "%.4f"|format(user.latitude) }}, {{ "%.4f"|format(user.longitude) }}</p>
            {% else %}
            <p>Location not set.</p>
            {% endif %}
        </div>
        <div class="location-actions">
            <button type="button" id="btn-geolocate" class="btn">Detect my location</button>
        </div>
        <div class="location-manual">
            <p>Or enter coordinates manually:</p>
            <div class="form-row">
                <div class="form-group">
                    <label for="manual-lat">Latitude</label>
                    <input type="number" id="manual-lat" step="0.0001" min="-90" max="90" value="{{ user.latitude or '' }}">
                </div>
                <div class="form-group">
                    <label for="manual-lng">Longitude</label>
                    <input type="number" id="manual-lng" step="0.0001" min="-180" max="180" value="{{ user.longitude or '' }}">
                </div>
            </div>
            <button type="button" id="btn-save-location" class="btn btn-small">Save location</button>
        </div>
        <p id="location-status" class="hint"></p>
    </section>

    <section class="profile-section">
        <h2>Stats</h2>
        <p>Fame rating: <strong>{{ user.fame_rating }}</strong></p>
        <p><a href="{{ url_for('profile.visitors') }}">View who visited your profile</a></p>
        <p><a href="{{ url_for('profile.likes') }}">View who liked you</a></p>
    </section>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    var btnGeo = document.getElementById('btn-geolocate');
    var btnSave = document.getElementById('btn-save-location');
    var status = document.getElementById('location-status');
    var latInput = document.getElementById('manual-lat');
    var lngInput = document.getElementById('manual-lng');

    function updateLocation(lat, lng, manual) {
        fetch('{{ url_for("profile.update_location") }}', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({latitude: lat, longitude: lng, manual: manual})
        }).then(function(r) { return r.json(); }).then(function(data) {
            if (data.success) {
                status.textContent = 'Location updated.';
                latInput.value = lat.toFixed(4);
                lngInput.value = lng.toFixed(4);
            } else {
                status.textContent = 'Failed to update location.';
            }
        }).catch(function() {
            status.textContent = 'Error updating location.';
        });
    }

    btnGeo.addEventListener('click', function() {
        if (!navigator.geolocation) {
            status.textContent = 'Geolocation not supported.';
            return;
        }
        status.textContent = 'Detecting location...';
        navigator.geolocation.getCurrentPosition(function(pos) {
            updateLocation(pos.coords.latitude, pos.coords.longitude, false);
        }, function(err) {
            status.textContent = 'Could not detect location. Please enter manually.';
        });
    });

    btnSave.addEventListener('click', function() {
        var lat = parseFloat(latInput.value);
        var lng = parseFloat(lngInput.value);
        if (isNaN(lat) || isNaN(lng) || lat < -90 || lat > 90 || lng < -180 || lng > 180) {
            status.textContent = 'Invalid coordinates.';
            return;
        }
        updateLocation(lat, lng, true);
    });

    var dropzone = document.getElementById('dropzone');
    var fileInput = document.getElementById('file-input');
    var csrfToken = document.querySelector('meta[name="csrf-token"]').content;

    if (dropzone) {
        dropzone.addEventListener('click', function() { fileInput.click(); });
        dropzone.addEventListener('dragover', function(e) {
            e.preventDefault();
            dropzone.classList.add('dragover');
        });
        dropzone.addEventListener('dragleave', function() {
            dropzone.classList.remove('dragover');
        });
        dropzone.addEventListener('drop', function(e) {
            e.preventDefault();
            dropzone.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        });
        fileInput.addEventListener('change', function() {
            handleFiles(fileInput.files);
        });
    }

    function handleFiles(files) {
        Array.from(files).forEach(function(file) {
            if (!file.type.startsWith('image/')) return;
            var formData = new FormData();
            formData.append('image', file);
            fetch('{{ url_for("profile.upload_image") }}', {
                method: 'POST',
                headers: { 'X-CSRFToken': csrfToken },
                body: formData
            }).then(function() { location.reload(); });
        });
    }

    var sortable = document.getElementById('images-sortable');
    if (sortable && sortable.children.length > 1) {
        var dragged = null;
        Array.from(sortable.children).forEach(function(card) {
            card.draggable = true;
            card.addEventListener('dragstart', function(e) {
                dragged = card;
                card.classList.add('dragging');
            });
            card.addEventListener('dragend', function() {
                card.classList.remove('dragging');
                saveOrder();
            });
            card.addEventListener('dragover', function(e) { e.preventDefault(); });
            card.addEventListener('drop', function(e) {
                e.preventDefault();
                if (dragged !== card) {
                    var allCards = Array.from(sortable.children);
                    var draggedIdx = allCards.indexOf(dragged);
                    var targetIdx = allCards.indexOf(card);
                    if (draggedIdx < targetIdx) {
                        sortable.insertBefore(dragged, card.nextSibling);
                    } else {
                        sortable.insertBefore(dragged, card);
                    }
                }
            });
        });
    }

    function saveOrder() {
        var ids = Array.from(sortable.children).map(function(c) { return c.dataset.id; });
        fetch('{{ url_for("profile.reorder_images") }}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
            body: JSON.stringify({ order: ids })
        });
    }

    var modal = document.getElementById('image-editor-modal');
    var editorImg = document.getElementById('editor-image');
    var currentEditId = null;
    var rotation = 0, flipH = false, flipV = false;

    document.querySelectorAll('.edit-image-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            currentEditId = btn.dataset.id;
            editorImg.src = btn.dataset.src;
            rotation = 0; flipH = false; flipV = false;
            document.getElementById('brightness').value = 100;
            document.getElementById('contrast').value = 100;
            applyFilters();
            modal.style.display = 'flex';
        });
    });

    document.getElementById('close-editor').addEventListener('click', function() { modal.style.display = 'none'; });
    document.getElementById('cancel-edit').addEventListener('click', function() { modal.style.display = 'none'; });

    document.getElementById('rotate-left').addEventListener('click', function() { rotation -= 90; applyFilters(); });
    document.getElementById('rotate-right').addEventListener('click', function() { rotation += 90; applyFilters(); });
    document.getElementById('flip-h').addEventListener('click', function() { flipH = !flipH; applyFilters(); });
    document.getElementById('flip-v').addEventListener('click', function() { flipV = !flipV; applyFilters(); });
    document.getElementById('brightness').addEventListener('input', applyFilters);
    document.getElementById('contrast').addEventListener('input', applyFilters);

    function applyFilters() {
        var b = document.getElementById('brightness').value;
        var c = document.getElementById('contrast').value;
        var transform = 'rotate(' + rotation + 'deg)';
        if (flipH) transform += ' scaleX(-1)';
        if (flipV) transform += ' scaleY(-1)';
        editorImg.style.transform = transform;
        editorImg.style.filter = 'brightness(' + (b/100) + ') contrast(' + (c/100) + ')';
    }

    document.getElementById('save-edit').addEventListener('click', function() {
        var b = document.getElementById('brightness').value;
        var c = document.getElementById('contrast').value;
        fetch('{{ url_for("profile.edit_image") }}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
            body: JSON.stringify({
                image_id: currentEditId,
                rotation: rotation,
                flip_h: flipH,
                flip_v: flipV,
                brightness: b,
                contrast: c
            })
        }).then(function() { location.reload(); });
    });
});
</script>
<style>
.dropzone-area {
    border: 2px dashed #bdc3c7;
    border-radius: 8px;
    padding: 2rem;
    text-align: center;
    cursor: pointer;
    transition: border-color 0.2s, background 0.2s;
    margin-top: 1rem;
}
.dropzone-area:hover, .dropzone-area.dragover {
    border-color: #3498db;
    background: #f0f7ff;
}
.image-card.dragging { opacity: 0.5; }
.modal {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.6);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}
.modal-content {
    background: #fff;
    border-radius: 8px;
    max-width: 500px;
    width: 90%;
    max-height: 90vh;
    overflow: auto;
}
.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    border-bottom: 1px solid #eee;
}
.modal-header h3 { margin: 0; }
.modal-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
}
.modal-body { padding: 1rem; }
.editor-preview {
    text-align: center;
    margin-bottom: 1rem;
    overflow: hidden;
}
.editor-preview img {
    max-width: 100%;
    max-height: 300px;
    transition: transform 0.2s, filter 0.2s;
}
.editor-controls, .editor-filters {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
    margin-bottom: 1rem;
}
.editor-filters label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.9rem;
}
.modal-footer {
    padding: 1rem;
    border-top: 1px solid #eee;
    display: flex;
    gap: 0.5rem;
    justify-content: flex-end;
}
</style>
{% endblock %}
